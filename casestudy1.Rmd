---
title: "casestudy1"
author: "Malcolm Carlson"
date: "10/4/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(magrittr)
library(dplyr)
library(tidyverse)
library(mice)
library(usmap)
library(ggplot2)
library(stringr)


#beerdf=read.csv("C:\\Users\\malco\\Documents\\MDS\\MDS_6306_DDS\\CaseS#tudy1\\Beers.csv",header=TRUE)
#breweriesdf=read.csv("C:\\Users\\malco\\Documents\\MDS\\MDS_6306_DDS\\CaseStudy1\\Breweries.csv",header=TRUE)
#IBU - International Bitterness Units
#ABV - Alcohol by Volume

#Cleanup to enable a key with same name
#Brew_ID,Name,City,State
#breweriesdf <- breweriesdf %>% rename(
#  Brewery_id = Brew_ID,
#   Brewery_name = Name
#)

#Change name to be more unique
#beerdf <- beerdf %>% rename(
#  Beer_name = Name
#)


#combineddf<-merge(breweriesdf,beerdf, by="Brewery_id",all = TRUE)
#sum(is.na(combineddf$ABV))
#sum(is.na(combineddf$IBU))

nona=read.csv(file="/Users/malco/Documents/MDS/MDS_6306_DDS/CaseStudy1/nona.csv",header=TRUE)
#view(nona)

```


#1. How many breweries are present in each state?
```{r}
#Createt for data in ascending order
stateSum=nona%>%group_by(State)%>%summarise(Brewery_count=n())
orderedstateSum<-stateSum[order(-stateSum$Brewery_count),]
write.csv(orderedstateSum,file="/Users/malco/Documents/MDS/MDS_6306_DDS/CaseStudy1/orderedstateSum.csv",row.names=FALSE)
#Top 20 ordered bar chart

top20=head(orderedstateSum,20)
top20%>%ggplot(aes(x=reorder(State,-Brewery_count),y=Brewery_count))+
  geom_bar(stat="identity",fill="green")+
  geom_text(aes(label=Brewery_count), vjust=1.6, color="black", size=3.5)+
  ggtitle("Top 20 States with most Breweries")+xlab("States")+ylab("Count of Breweries")

#Bottom 30 ordered bar chart
bottom30=tail(orderedstateSum,30)
#view(bottom30)
bottom30%>%ggplot(aes(x=reorder(State,-Brewery_count),y=Brewery_count))+
  geom_bar(stat="identity",fill="green")+geom_text(aes(label=Brewery_count), vjust=1.6, color="black", size=3)+
  ggtitle("Bottom 30 States w Brewery Count")+xlab("States")+ylab("Count of Breweries")

orderedstateSum%>%ggplot(aes(x=reorder(State,-Brewery_count),y=Brewery_count))+
  geom_bar(stat="identity",fill="green")+
  geom_text(aes(label=Brewery_count), vjust=1.2, color="black", size=3)+
  ggtitle("All States")+xlab("States")+ylab("Count of Breweries")



#map of 50 states with # of breweries?

```

#2.  Merge beer data with the breweries data. 
#Print the first 6 observations and the last six #observations to check the merged file.
```{r}

top6merge<-head(nona)
bottom6merge<-tail(nona)
view(top6merge,title = "Top 6 head data for merged dataset")
view(bottom6merge,title = "Bottom 6 head data for merged dataset")
```

#3. Address the missing values in each column.
#Uncomment to re-run imputation
```{r}

#init = mice(combineddf, maxit=0)
#predM = init$predictorMatrix
#predM[, c("Beer_name", "Beer_ID", "Ounces", "Brewery_name")]=0
#imp<-mice(combineddf, m=5, predictorMatrix = predM)
#nona <- complete(imp)
#view(nona)
#nona$State<-trimws(nona$State)
#write.csv(nona,file="/Users/malco/Documents/MDS/MDS_6306_DDS/CaseStudy1/nona.csv",row.names=FALSE)
nona=read.csv(file="/Users/malco/Documents/MDS/MDS_6306_DDS/CaseStudy1/nona.csv",header=TRUE)
#view(nona)
```
#4. Compute the median alcohol content and international #bitterness unit for each state. Plot a bar chart to #compare. ABV,IBU
#Bar chart of top 20, bar chart for the rest in #ascending order
```{r}
nona$State = as.character(nona$State)
nona$State = str_trim(nona$State)
#Dataframe of just State,ABV,IBU
medianABVIBU<-nona%>%group_by(State)%>%summarize(medianABV=median(ABV),medianIBU=median(IBU))
head(medianABVIBU)
#Code for Top 20 highes ABV by State                                    
top20medABV=head(medianABVIBU,20)
top20medABV<-top20medABV%>%select(State,medianABV)
head(top20medABV)
top20medABV%>%ggplot(aes(x=reorder(State,-medianABV),y=medianABV))+
  geom_bar(stat="identity",fill="green")+geom_text(aes(label=medianABV), vjust=1.6, color="black", size=3)+
ggtitle("Highest Median Alcohol by Volumes by State")+xlab("States")+ylab("Alcohol by Volume")

#Code for ascending ordered ABV by State
remainingABV=tail(medianABVIBU,30)
remainingABV<-remainingABV%>%select(State,medianABV)
remainingABV%>%ggplot(aes(x=reorder(State,-medianABV),y=medianABV))+
  geom_bar(stat="identity",fill="green")+geom_text(aes(label=medianABV), vjust=1.6, color="white", size=3)+
ggtitle("Remaining States by Alcohol by Volume")+xlab("States")+ylab("Alcohol by Volume")
head(top20medABV)
```

#5. Which state has the maximum alcoholic (ABV) beer? Which #state has the most bitter (IBU) #beer?
```{r}
#Code to selct by ABV and IBU and find max value
maxABV<-nona%>%group_by(State)%>%select(State,ABV)
maxIBU<-nona%>%group_by(State)%>%select(State,IBU)
maxABV[which.max(maxABV$ABV), ]
maxIBU[which.max(maxIBU$IBU), ]
#need bar chart of top 10

```
#6. Comment on the summary statistics and distribution of the #ABV variable.
```{r}
justABV<-nona%>%select(ABV)
summary(justABV)

hist(justABV$ABV,
     main="Histogram of Alcohol by Volume of beer population",
     xlab="Alcohol by Volume",
     ylab="Beer population",
     col="green",
     border="black"
     )
nona%>%ggplot(aes(x=ABV,fill=State))+geom_histogram(bins=30)+ggtitle("Alcohol by Volume Distribution of Beer population")+xlab("ABV Content")+ylab("Number of Beers")

#1 sample t-test of ABV data
t.test(x=justABV, conf.int = "TRUE", alternative = "two.sided")

justIBU<-nona%>%select(IBU)
summary(justIBU)
hist(justIBU$IBU,
     main="Histogram of International Bitternes Units of beer population",
     xlab="International Bitternes Units",
     ylab="Beer population",
     col="green",
     border="black"
     )
nona%>%ggplot(aes(x=IBU,color=State))+geom_histogram(bins=30)+ggtitle("Distribution of Bitterness of Beer population")+xlab("Bitterness")+ylab("Number of Beers")
```


#7. Is there an apparent relationship between the bitterness # of the beer and its alcoholic content? Draw a scatter plot.  #Make your best judgment of a relationship and EXPLAIN your #answer.
```{r}
qplot(seq_along(nona$ABV),nona$ABV,main="Scatter Plot of ABV",xlab="ABV")
qplot(seq_along(nona$IBU),nona$IBU, main="Scatter Plot of IBU",xlab="IBU")

styledf<-nona%>%select(State,Style,ABV,IBU)
styledf%>%ggplot(aes(x=ABV,y=IBU,color=State))+geom_point()+ggtitle("ABV vs IBU")

```
#plot of breweries,beers,styles per state
```{r}
#Code to merge statepop dataset with nona
#statepopmod <- statepop %>% rename(State = abbr)
#nona$State<-trimws(nona$State)
#popuNnonadf<-merge(statepopmod,nona,by="State")
#write.csv(popuNnonadf,file="/Users/malco/Documents/MDS/MDS_6306_DDS/DDS#-CaseStudy1/popuNnonadf.csv",row.names=FALSE)
#fips<chr>,abbr<chr>,full<chr>,pop_2015<dbl>
#Brewery_id<int>,Brewery_name<fctr>,City<fctr>,State<fctr>,Beer_ID<int>,#ABV<dbl>,IBU<int>,Style<fctr>,Ounces<dbl>
#popuNnonadf=read.csv(file="/Users/malco/Documents/MDS/MDS_6306_DDS/DDS-CaseStudy1/popuNnonadf.csv",header=TRUE)
#head(popuNnonadf)

#beerSum=nona%>%group_by(State)%>%summarise(Beer_name=n())
#beerSum<-beerSum%>%rename(BeerNums = Beer_name)

#popuNnonadf%>%select(State,full,pop_2015)
#justbrew<-popuNnonadf%>%group_by(State)%>%summarise(Beer_name=n())
#head(justbrew)
#head(popuNnonadf)
#statebrew<-merge(justbrew,popuNnonadf,by=State)
#head(statebrew)
#statebrew=(abbr,Full State Name, NumBrews,pop2015,pop2015/NumBrews)
```
#Jason's plots of the us map.
#need to add breweries
```{r}
statesum = count(nona, vars = State)
temp = statepop
statesum$vars = as.character(statesum$vars)
statesum$vars = str_trim(statesum$vars)
statebrew = merge(statesum, temp, by.x = "vars", by.y = "abbr")
names(statebrew)[names(statebrew) == "vars"] <- "abbr"
names(statebrew)[names(statebrew) == "n"] <- "count"
statebrew$per_cap <- statebrew$pop_2015 / statebrew$count
head(statebrew)
```

```{r}
#head(nona)
#head(statebrew)
#allbrews = merge(statebrew, nona, by.x = "abbr", by.y = "State")
#head(allbrews)
```
#### Craft beers by state
```{r}

plot_usmap(data = statebrew, values = "count", color = "red") + 
  scale_fill_continuous(name = "Beers by State", label = scales::comma) + 
  theme(legend.position = "right")
```
```{r}
plot_usmap(data = statebrew, values = "count", color = "black") + 
  scale_fill_continuous(
    low = "white", high = "green", name = "Beers by State", label = scales::comma
  ) + theme(legend.position = "right")
```
#####  states pop div by beers
```{r}

plot_usmap(data = statebrew, values = "per_cap", color = "red") + 
  scale_fill_continuous(
    low = "white", high = "red", name = "States Population div by beers", label = scales::comma
  ) + theme(legend.position = "right")
```
# remove n/a's from the data
# merge data to one master data frame
```{r}

nona$State = as.character(nona$State)
nona$State = str_trim(nona$State)

allbrews = merge(statebrew, nona, by.x = "abbr", by.y = "State")
head(allbrews)
```
# compute the ABV state stats
# compute the IBU state stats
```{r}

stateABV = allbrews %>%
  group_by(abbr) %>%
  summarise_each(funs(max, min, mean, median, sd), ABV)


stateIBU = allbrews %>%
  group_by(abbr) %>%
  summarise_each(funs(max, min, mean, median, sd), IBU)

stateABV = merge(temp, stateABV, by.x = "abbr", by.y = "abbr")
stateIBU = merge(temp, stateIBU, by.x = "abbr", by.y = "abbr")

```

### ABV usa
```{r}
plot_usmap(data = stateABV, values = "median", color = "black") + scale_fill_continuous(low = "white", high = "green", name = "Alcohol by Volume by State"  ) + theme(legend.position =
"right")
```
#### IBU usa
```{r}
plot_usmap(data = stateIBU, values = "median", color = "black") + labs(title = "Median IBU by all 50 States", subtitle = "This is a map of the IBU by State.") +
  scale_fill_continuous(
    low = "green", high = "darkgreen", name = "IBU by State"  ) + theme(legend.position = "right")

```
#### Max ABV
```{r}
plot_usmap(data = stateABV, values = "max", include = "CO", color = "red") + labs(title = "Max ABV by State", subtitle = "This is a map of the State with the highest ABV") +
  scale_fill_continuous(
    low = "white", high = "midnightblue", name = "ABV"  ) + theme(legend.position = "right")

```
#### Max IBU
```{r}
plot_usmap(data = stateIBU, values = "max", include = "CO", color = "red") + labs(title = "Max IBU by State", subtitle = "This is a map of the State with the highest IBU") +
  scale_fill_continuous(
    low = "white", high = "midnightblue", name = "IBU"  ) + theme(legend.position = "right")

```

#linear regression to see if relationship exists between
#ABV and IBU
```{r}
nona%>%ggplot(aes(x=ABV,y=IBU))+geom_point()+geom_smooth(method="lm")

fit = lm(IBU~ABV, data = nona) 
summary(fit)
```
#Question of interest.  What style is most popular, least
#by region?
```{r}


```

#8.  Use KNN - For final presentation 
```{r}


```
#Jason's beer style code
```{r}

styles = c("IPA", "APA", "Blonde ale", "brown ale", "red ale", "ale", "lager", "stout", "cider", "porter", "pilsner", "hefeweizen" ,"pilsener", "witbier", "fruit", "KÃ¶lsch")
beers = data.frame(styles)
beers$nodata = 0
allbrews$class = ""
allbrews$used = FALSE
allbrews$Beer_name = as.character(allbrews$Beer_name)
beers$styles = as.character(beers$styles)
for (i in 1:dim(allbrews)[1]) {
  for (j in 1:dim(beers)[1]) {
    x = beers[j,]$style
    y = allbrews[i,]$Style
    if (str_detect(y, regex(x, ignore_case = TRUE)) & allbrews[i,]$used != TRUE) {
      allbrews[i,]$class = beers[j,]$style
      allbrews[i,]$used = TRUE
    }
  }
}
for (i in 1:dim(allbrews)[1]) {
  if (allbrews[i,]$used == FALSE) {
    allbrews[i,]$class = "other"
  }
  if (allbrews[i,]$class == "Pilsener" | allbrews[i,]$class == "pilsener") {
    allbrews[i,]$class = "pilsner"
  }
}    

```
# plot ABV vs IBU to see any relationships
# compute the means for the ABV and IBU by style and then plot
```{r}

stylesum = count(allbrews, vars = class) 
stylemeans = stylesum
stylemeans$ABVmean = 0
stylemeans$IBUmean = 0
stylemeans$ABVtotal = 0
stylemeans$IBUtotal = 0
for (i in 1:dim(allbrews)[1]) {
  for (j in 1:dim(stylesum)[1]) {
  
    if (allbrews[i,]$class == stylesum[j,]$vars) {
      stylemeans[j,]$ABVtotal = stylemeans[j,]$ABVtotal + allbrews[i,]$ABV
      stylemeans[j,]$IBUtotal = stylemeans[j,]$IBUtotal + allbrews[i,]$IBU
    }
    
  }
}

for (j in 1:dim(stylemeans)[1]) {
  stylemeans[j,]$ABVmean = stylemeans[j,]$ABVtotal / stylemeans[j,]$n
  stylemeans[j,]$IBUmean = stylemeans[j,]$IBUtotal / stylemeans[j,]$n
}

stylemeans$ABVmean = round(stylemeans$ABVmean, 4)
stylemeans$IBUmean = round(stylemeans$IBUmean, 4)
names(stylemeans)[names(stylemeans) == "vars"] <- "abbr"
names(stylemeans)[names(stylemeans) == "n"] <- "count"


names(stylemeans)[names(stylemeans) == "abbr"] <- "Style"


gg <- ggplot(stylemeans, aes(x=ABVmean, y=IBUmean)) +
  geom_point(aes(col=Style, size=count)) +
  labs(subtitle="ABV vs IBU",
       y="IBU",
       x="ABV",
       title="Beer Style ABV vs IBU",
       caption = "Source: Brewery Data")

plot(gg)

```
#9.  Look at, have a direction!
```{r}

```