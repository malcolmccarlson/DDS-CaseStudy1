---
title: "casestudy1"
author: "Malcolm Carlson"
date: "10/4/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(magrittr)
library(dplyr)
library(tidyverse)
library(mice)
library(usmap)
library(ggplot2)
library(stringr)
```

```{r}
beerdf=read.csv("C:\\Users\\malco\\Documents\\MDS\\MDS_6306_DDS\\CaseStudy1\\Beers.csv",header=TRUE)
breweriesdf=read.csv("C:\\Users\\malco\\Documents\\MDS\\MDS_6306_DDS\\CaseStudy1\\Breweries.csv",header=TRUE)
#IBU - International Bitterness Units
#ABV - Alcohol by Volume

#Cleanup to enable a key with same name
#Brew_ID,Name,City,State
breweriesdf <- breweriesdf %>% rename(
    Brewery_id = Brew_ID,
    Brewery_name = Name)

#Change name to be more unique
beerdf <- beerdf %>% rename(
  Beer_name = Name
)


combineddf<-merge(breweriesdf,beerdf, by="Brewery_id",all = TRUE)
sum(is.na(combineddf$ABV))
sum(is.na(combineddf$IBU))

nona=read.csv(file="/Users/malco/Documents/MDS/MDS_6306_DDS/CaseStudy1/nona.csv",header=TRUE)


```


#1. How many breweries are present in each state?
```{r}
#Created for data in ascending order
stateSum=breweriesdf%>%group_by(State)%>%summarise(Brewery_count=n())
orderedstateSum<-stateSum[order(-stateSum$Brewery_count),]
write.csv(orderedstateSum,file="/Users/malco/Documents/MDS/MDS_6306_DDS/CaseStudy1/orderedstateSum.csv",row.names=FALSE)

#Top 10 ordered bar chart
top10=head(orderedstateSum,10)
top10%>%ggplot(aes(x=reorder(State,-Brewery_count),y=Brewery_count))+
  geom_bar(stat="identity",fill="Blue")+
  geom_text(aes(label=Brewery_count), vjust=1.6, color="white", size=3.5)+
  ggtitle("Top 10 States with most Breweries")+xlab("States")+ylab("Count of Breweries")

```

#2.  Merge beer data with the breweries data. 
#Print the first 6 observations and the last six #observations to check the merged file.
```{r}

top6merge<-head(nona)
bottom6merge<-tail(nona)
view(top6merge,title = "Top 6 head data for merged dataset")
view(bottom6merge,title = "Bottom 6 head data for merged dataset")
```

#3. Address the missing values in each column.
#Uncomment to re-run imputation
```{r}
init = mice(combineddf, maxit=0)
predM = init$predictorMatrix
predM[, c("Beer_name", "Beer_ID", "Ounces", "Brewery_name")]=0
imp<-mice(combineddf, m=5, predictorMatrix = predM)
nona <- complete(imp)
view(nona)
nona$State<-trimws(nona$State)
write.csv(nona,file="/Users/malco/Documents/MDS/MDS_6306_DDS/CaseStudy1/nona.csv",row.names=FALSE)
nona=read.csv(file="/Users/malco/Documents/MDS/MDS_6306_DDS/CaseStudy1/nona.csv",header=TRUE)

```
#4. Compute the median alcohol content and international bitterness #unit for each state. Plot a bar chart to compare. ABV,IBU
#Bar chart of top 10, bar chart for the rest in #ascending order
```{r}
nona$State = as.character(nona$State)
nona$State = str_trim(nona$State)

#Dataframe of just State,ABV,IBU
medianABVIBU<-nona%>%group_by(State)%>%summarize(medianABV=median(ABV),medianIBU=median(IBU))
head(medianABVIBU)

#Code for Top 10 highes ABV by State                                   
top10medABV=head(medianABVIBU,10)
top10medABV<-top10medABV%>%select(State,medianABV)
head(top10medABV)
top10medABV%>%ggplot(aes(x=reorder(State,-medianABV),y=medianABV))+
  geom_bar(stat="identity",fill="blue")+geom_text(aes(label=medianABV), vjust=1.6, color="white", size=3)+
ggtitle("Highest Median Alcohol by Volumes by State")+xlab("States")+ylab("Alcohol by Volume")

```

#5. Which state has the maximum alcoholic (ABV) beer? Which #state has the most bitter (IBU) #beer?
```{r}
#Code to selct by ABV and IBU and find max value
maxABV<-nona%>%group_by(State)%>%select(State,ABV)
maxIBU<-nona%>%group_by(State)%>%select(State,IBU)
maxABV[which.max(maxABV$ABV), ]
maxIBU[which.max(maxIBU$IBU), ]

```
#6. Comment on the summary statistics and distribution of the #ABV variable.
```{r}
justABV<-nona%>%select(ABV)

```

```{r}
x <- justABV$ABV
h<-hist(x,
     main="Histogram of Alcohol by Volume",
     xlab="Alcohol by Volume",
     ylab="Beer population",
     col="blue",
     border="black"
     )
xfit<-seq(min(x),max(x),length=40)
yfit<-dnorm(xfit,mean=mean(x),sd=sd(x))
yfit <- yfit*diff(h$mids[1:2])*length(x)
lines(xfit, yfit, col="blue", lwd=2)

```
#ABV Summary Data
```{r}
summary(justABV)
justABV%>%ggplot(aes(x="", y=ABV,fill=ABV))+geom_boxplot(width=.4,fill="lightblue")+ylab("ABV")+ggtitle("Box plot of ABV Summary Statistics")

```

#IBU Summary data
```{r}
justIBU<-nona%>%select(IBU)
summary(justIBU)
justIBU%>%ggplot(aes(x="", y=IBU,fill=IBU))+geom_boxplot(width=.4,fill="lightblue")+ylab("IBU")+ggtitle("Box plot of IBU Summary Statistics")

```

#7. Is there an apparent relationship between the bitterness of the #beer and its alcoholic content? Draw a scatter plot.  Make your best #judgment of a relationship and EXPLAIN your #answer.
```{r}
qplot(seq_along(nona$ABV),nona$ABV,main="Scatter Plot of ABV",xlab="ABV")
qplot(seq_along(nona$IBU),nona$IBU, main="Scatter Plot of IBU",xlab="IBU")

styledf<-nona%>%select(State,Style,ABV,IBU)
styledf%>%ggplot(aes(x=ABV,y=IBU,color=State))+geom_point()+ggtitle("ABV vs IBU")

```
#Jason's plots of the us map.
#need to add breweries
```{r}
statesum = count(nona, vars = State)
brewerysum=breweriesdf%>%group_by(State)%>%summarise(Brewery_count=n())

temp = statepop
statesum$vars = as.character(statesum$vars)
statesum$vars = str_trim(statesum$vars)
brewerysum$State = as.character(brewerysum$State)
brewerysum$State = str_trim(brewerysum$State)
statebrew = merge(statesum, temp, by.x = "vars", by.y = "abbr")
statebrew = merge(brewerysum, statebrew, by.x = "State", by.y  = "abbr")
names(statebrew)[names(statebrew) == "vars"] <- "abbr"
names(statebrew)[names(statebrew) == "n"] <- "count"
statebrew$per_cap <- statebrew$pop_2015 / statebrew$count
statesum
dim(statebrew)
```
#Q1 Cont.  US map of breweries by state
```{r}
plot_usmap(data = statebrew, values = "Brewery_count", color = "red") + 
  scale_fill_continuous(name = "Craft Breweries by State", label = scales::comma) + 
  theme(legend.position = "right")
```
# Craft beers by state
```{r}
plot_usmap(data = statebrew, values = "count", color = "red") + 
  scale_fill_continuous(name = "Beers by State", label = scales::comma) + theme(legend.position = "right")
```

#  states population div by beers
```{r}

plot_usmap(data = statebrew, values = "per_cap", color = "black") + 
  scale_fill_continuous(
    low = "white", high = "darkblue", name = "States Population div by beers", label = scales::comma
  ) + theme(legend.position = "right")
```
# remove n/a's from the data
# merge data to one master data frame
```{r}

nona$State = as.character(nona$State)
nona$State = str_trim(nona$State)

allbrews = merge(statebrew, nona, by.x = "abbr", by.y = "State")
head(allbrews)
```
# compute the ABV state stats
# compute the IBU state stats
```{r}

stateABV = allbrews %>%
  group_by(abbr) %>%
  summarise_each(funs(max, min, mean, median, sd), ABV)


stateIBU = allbrews %>%
  group_by(abbr) %>%
  summarise_each(funs(max, min, mean, median, sd), IBU)

stateABV = merge(temp, stateABV, by.x = "abbr", by.y = "abbr")
stateIBU = merge(temp, stateIBU, by.x = "abbr", by.y = "abbr")

```

# ABV usa
```{r}
plot_usmap(data = stateABV, values = "median", color = "black") + scale_fill_continuous(low = "white", high = "blue", name = "ABV by State"  ) + theme(legend.position =
"right")
```
# IBU usa
```{r}
plot_usmap(data = stateIBU, values = "median", color = "black") + 
  scale_fill_continuous(
    low = "blue", high = "white", name = "IBU by State"  ) + theme(legend.position = "right")

```
# Max ABV
```{r}
plot_usmap(data = stateABV, values = "max", include = "CO", color = "red") + labs(title = "Colorado") +
  scale_fill_continuous(
    low = "white", high = "midnightblue", name = "ABV"  ) + theme(legend.position = "right")

```
# Max IBU
```{r}
plot_usmap(data = stateIBU, values = "max", include = "CO", color = "red") + labs(title = "Colorado") +
  scale_fill_continuous(
    low = "white", high = "midnightblue", name = "IBU"  ) + theme(legend.position = "right")

```
#Q7 Analysis
#linear regression to see if relationship exists between
#ABV and IBU
```{r}
nona%>%ggplot(aes(x=ABV,y=IBU))+geom_point()+geom_smooth(method="lm")

fit = lm(IBU~ABV, data = nona) 
summary(fit)
```

#Jason's beer style code for Q7
```{r}

styles = c("IPA", "APA", "Blonde ale", "brown ale", "red ale", "ale", "lager", "stout", "cider", "porter", "pilsner", "hefeweizen" ,"pilsener", "witbier", "fruit", "KÃ¶lsch")
beers = data.frame(styles)
beers$nodata = 0
allbrews$class = ""
allbrews$used = FALSE
allbrews$Beer_name = as.character(allbrews$Beer_name)
beers$styles = as.character(beers$styles)
for (i in 1:dim(allbrews)[1]) {
  for (j in 1:dim(beers)[1]) {
    x = beers[j,]$style
    y = allbrews[i,]$Style
    if (str_detect(y, regex(x, ignore_case = TRUE)) & allbrews[i,]$used != TRUE) {
      allbrews[i,]$class = beers[j,]$style
      allbrews[i,]$used = TRUE
    }
  }
}
for (i in 1:dim(allbrews)[1]) {
  if (allbrews[i,]$used == FALSE) {
    allbrews[i,]$class = "other"
  }
  if (allbrews[i,]$class == "Pilsener" | allbrews[i,]$class == "pilsener") {
    allbrews[i,]$class = "pilsner"
  }
}    

```
# plot ABV vs IBU to see any relationships
# compute the means for the ABV and IBU by style and then plot
```{r}

stylesum = count(allbrews, vars = class) 
stylemeans = stylesum
stylemeans$ABVmean = 0
stylemeans$IBUmean = 0
stylemeans$ABVtotal = 0
stylemeans$IBUtotal = 0
for (i in 1:dim(allbrews)[1]) {
  for (j in 1:dim(stylesum)[1]) {
  
    if (allbrews[i,]$class == stylesum[j,]$vars) {
      stylemeans[j,]$ABVtotal = stylemeans[j,]$ABVtotal + allbrews[i,]$ABV
      stylemeans[j,]$IBUtotal = stylemeans[j,]$IBUtotal + allbrews[i,]$IBU
    }
    
  }
}

for (j in 1:dim(stylemeans)[1]) {
  stylemeans[j,]$ABVmean = stylemeans[j,]$ABVtotal / stylemeans[j,]$n
  stylemeans[j,]$IBUmean = stylemeans[j,]$IBUtotal / stylemeans[j,]$n
}

stylemeans$ABVmean = round(stylemeans$ABVmean, 4)
stylemeans$IBUmean = round(stylemeans$IBUmean, 4)
names(stylemeans)[names(stylemeans) == "vars"] <- "abbr"
names(stylemeans)[names(stylemeans) == "n"] <- "count"


names(stylemeans)[names(stylemeans) == "abbr"] <- "Style"


gg <- ggplot(stylemeans, aes(x=ABVmean, y=IBUmean)) +
  geom_point(aes(col=Style, size=count)) +
  labs(subtitle="ABV vs IBU",
       y="IBU",
       x="ABV",
       title="Beer Style ABV vs IBU",
       caption = "Source: Brewery Data")

plot(gg)

```
#8.  Use KNN - For final presentation
#Budweiser would also like to investigate the difference with respect #to IBU and ABV between IPAs (India Pale Ales) and other types of Ale #(any beer with “Ale” in its name other than IPA).  
#classify IPA vs Regular Ale by ABV and IBU
```{r}
library(stringr)
library(class)
library(caret)
library(e1071)

#allAles<-nona%>%select(Style,ABV,IBU)

styleSubset <- nona%>%select(Style,ABV,IBU)
beermatch <- c("IPA","Ale","India Pale Ale")
allAles <-styleSubset[grep(paste(beermatch,collapse="|"),styleSubset$Style,ignore.case = TRUE),]

allAles$styleClass <- ifelse(grepl("IPA", allAles$Style,ignore.case = T), "IPA", 
         ifelse(grepl("Ale", allAles$Style, ignore.case = T), "Ale", "Ale"))
dim(allAles)

```

```{r}
set.seed(6)
perc=.8
trainIndices = sample(1:dim(allAles)[1],round(perc * dim(allAles)[1]))
train = allAles[trainIndices,]
test = allAles[-trainIndices,]

iterations=30

accs = data.frame(accuracy = numeric(iterations), k = numeric(iterations))

for(i in 1:iterations)
{
  classifications = knn(train[,c(2,3)],test[,c(2,3)],train$styleClass, prob = TRUE, k = i)
  table(test$styleClass,classifications)
  CM = confusionMatrix(table(test$styleClass,classifications))
  accs$accuracy[i] = CM$overall[1]
  accs$k[i] = i
}
plot(accs$k,accs$accuracy, type = "l", xlab = "Values of k",ylab="Accuracy",main="Multinomial Beer Data accross k from 1 to 30")
CM
```
#KNN plot with boundary
#https://stackoverflow.com/questions/31234621/variation-on-how-to-plot-decision-boundary-of-a-k-nearest-neighbor-classifier-f/31236327
```{r}
#Data covering grid
require(MASS)
allIPA <- allAles%>%filter(styleClass)%>%select(StyleClass=="IPA")
cl <- factor(c(rep("IPA",25),rep("Ale",25)))
test <- expand.grid(x=seq(min(train[,4]-1), max(train[,4]+1),
                           by=0.1),
                     y=seq(min(train[,4]-1), max(train[,4]+1), 
                           by=0.1))

#Classification for the grid
require(class)
 classif <- knn(train, test, cl, k = 2, prob=TRUE)
 prob <- attr(classif, "prob")
 
#Data structure for plotting
require(dplyr)
dataf <- bind_rows(mutate(test,
                          prob=prob,
                          cls="IPA",
                          prob_cls=ifelse(classif==cls,
                          1, 0)),
                  mutate(test,
                          prob=prob,
                          cls="ALE",
                          prob_cls=ifelse(classif==cls,
                                       1, 0)))
#plot
require(ggplot2)
ggplot(dataf) +
  geom_point(aes(x=x, y=y, col=cls),
              data = mutate(test, cls=classif),
              size=1.2) + 
  geom_contour(aes(x=x, y=y, z=prob_cls, group=cls, color=cls),
              bins=2,
              data=dataf) +
  geom_point(aes(x=x, y=y, col=cls),
              size=3,
              data=data.frame(x=train[,1], y=train[,2], cls=cl))
```
#9.
#I had an idea for part of the EDA.  Maybe pick 'regions' of the US and #see if there is a trend to the type of beer or alcohol content? 
```{r}
#.northeast_region      # c(.new_england, .mid_atlantic)
#> [1] "CT" "MA" "ME" "NH" "RI" "VT" "NJ" "NY" "PA"
nestates=c("CT","MA","ME","NH","RI","VT","NJ","NY","PA")
neregion <- allbrews%>%select(fips,abbr,ABV,IBU,Brewery_name,Brewery_id,Style)%>%filter(abbr %in% nestates )
names(neregion)[names(neregion) == "abbr"] <- "State"
plot_usmap(data = neregion, values = "ABV" , color = "black", include = .northeast_region) + 
  scale_fill_continuous(
    low = "white", high = "darkblue", name = "Northeast Region", label = scales::comma
  ) + theme(legend.position = "right")
head(neregion)
```

```{r}
#.north_central_region  # c(.east_north_central, .west_north_central)
#>  [1] "IL" "IN" "MI" "OH" "WI" "IA" "KS" "MN" "MO" "NE" "ND" "SD"
plot_usmap(data = statebrew, values = "count", color = "black", include = .north_central_region) + 
  scale_fill_continuous(
    low = "white", high = "darkblue", name = "Northeast Central", label = scales::comma
  ) + theme(legend.position = "right")

```

```{r}
#.midwest_region
#>  [1] "IL" "IN" "MI" "OH" "WI" "IA" "KS" "MN" "MO" "NE" "ND" "SD"

plot_usmap(data = statebrew, values = "count", color = "black", include = .midwest_region) + 
  scale_fill_continuous(
    low = "white", high = "darkblue", name = "Midwest Region", label = scales::comma
  ) + theme(legend.position = "right")

```

#.south_region          # c(.south_atlantic, .east_south_central, #.west_south_central)
#>  [1] "DC" "DE" "FL" "GA" "MD" "NC" "SC" "VA" "WV" "AL" "KY" "MS" #"TN" "AR"
#> [15] "LA" "OK" "TX"
```{r}
plot_usmap(data = statebrew, values = "count", color = "black", include = .south_region) + 
  scale_fill_continuous(
    low = "white", high = "darkblue", name = "South Region", label = scales::comma
  ) + theme(legend.position = "right")


```
#.west_region           # c(.mountain, .pacific)
#>  [1] "AZ" "CO" "ID" "MT" "NV" "NM" "UT" "WY" "AK" "CA" "HI" "OR" #"WA"
```{r}
plot_usmap(data = statebrew, values = "count", color = "black", include = .west_region) + 
  scale_fill_continuous(
    low = "white", high = "darkblue", name = "West Region", label = scales::comma
  ) + theme(legend.position = "right")

```